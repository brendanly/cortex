# env CORTEX_SO_MAX_CONN
# env CORTEX_PROCESSES_PER_REPLICA

# good articles to read
# https://hub.packtpub.com/fine-tune-nginx-configufine-tune-nginx-configurationfine-tune-nginx-configurationratio/
# https://www.nginx.com/blog/tuning-nginx/
# https://www.digitalocean.com/community/tutorials/understanding-nginx-http-proxying-load-balancing-buffering-and-caching
# https://serverfault.com/a/788703

daemon off;
# maximum number of open files per worker
worker_rlimit_nofile 65535;
worker_processes 1;

events {
    # max_clients = (worker_processes * worker_connections ) / (X * 2) for reverse proxy
    # max clients is also limited by the number of socket connections available on the system (~64k)
    # arbitrary high number close to ~64k
    worker_connections 65535;

    # The multi_accept flag enables an NGINX worker to accept as many connections as possible when it
    # gets the notification of a new connection. The purpose of this flag is to accept all connections
    # in the listen queue at once. If the directive is disabled, a worker process will accept connections one by one.
    # multi_accept on;

    # An efficient method of processing connections available on Linux 2.6+. The method is similar to the FreeBSD kqueue.
    use epoll;
}

http {
    # send headers in one piece, it is better than sending them one by one
    tcp_nopush on;

    # don't buffer data sent, good for small data bursts in real time
    tcp_nodelay on;

    limit_conn_zone 1 zone=inflights:1m;

    upstream uvicorn {
        least_conn;
        server unix:/run/uvicorn/proc-1.sock max_fails=1 fail_timeout=30s;
        server unix:/run/uvicorn/proc-2.sock max_fails=1 fail_timeout=30s;
        server unix:/run/uvicorn/proc-3.sock max_fails=1 fail_timeout=30s;
        server unix:/run/uvicorn/proc-4.sock max_fails=1 fail_timeout=30s;
    }

    server {
        listen 8888;
        underscores_in_headers on;
        location / {
            limit_conn inflights 10;

            proxy_set_header HOST $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_redirect off;
            proxy_buffering off;

            proxy_pass http://uvicorn;
        }
    }
}
